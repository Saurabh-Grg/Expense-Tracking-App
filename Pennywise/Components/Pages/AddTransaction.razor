@page "/add-transaction"
@using Pennywise.Components.Layout
@using System.Text.Json
@layout LayoutWithNavmenu
@using Pennywise.Components.Models
@using Pennywise.Components.Helpers
@inject NavigationManager Navigator
@using System.Diagnostics

<body>
    <h3>Add New Transaction</h3>

    <EditForm Model="@newTransaction" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Title -->
        <div class="form-group">
            <label for="title">Title</label>
            <InputText id="title" class="form-control" @bind-Value="newTransaction.Title" required />
        </div>

        <!-- Amount -->
        <div class="form-group">
            <label for="amount">Amount</label>
            <InputNumber id="amount" class="form-control" @bind-Value="newTransaction.Amount" required />
        </div>

        <!-- Type -->
        <div class="form-group">
            <label for="type">Type</label>
            <InputSelect id="type" class="form-control" @bind-Value="newTransaction.Type" required>
                <option value="" disabled selected>Select transaction type</option>
                <option value="Income">Income</option>
                <option value="Expense">Expense</option>
                <option value="Debt">Debt</option>
            </InputSelect>
        </div>

        @if (newTransaction.Type == "Debt")
        {
            <div class="form-group">
                <div>
                    <label>Debt Source</label>
                </div>
                <input style="width: 100%" type="text" @bind="newTransaction.DebtSource" />
            </div>
            <div class="form-group">
                <div>
                    <label>Due Date</label>
                </div>
                <input style="width: 100%" type="date" @bind="newTransaction.DueDate" />
            </div>
        }

        <!-- Date -->
        <div class="form-group">
            <label for="date">Date</label>
            <InputDate id="date" class="form-control" @bind-Value="newTransaction.Date" required />
        </div>

        <!-- Category -->
        <div class="form-group">
            <label for="category">Category</label>
            <InputText id="category" class="form-control" @bind-Value="newTransaction.Category" required />
        </div>

        <!-- Tags -->
        <div class="form-group">
            <label for="tags">Tags</label>
            <InputText id="tags" class="form-control" @bind-Value="newTransaction.Tags" placeholder="Comma-separated tags" />
        </div>

        <!-- Notes -->
        <div class="form-group">
            <label for="notes">Notes</label>
            <InputText id="notes" class="form-control" @bind-Value="newTransaction.Notes" />
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-success">Save</button>
            <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
        </div>
    </EditForm>
</body>

@code {
    private Transaction newTransaction = new Transaction { Date = DateTime.Now };

    private async Task HandleValidSubmit()
    {
        try
        {
            var user = UserStorage.LoadUser();
            if (user == null)
            {
                Debug.WriteLine("No user found. Operation aborted.");
                return;
            }

            // Set the UserId for the transaction
            newTransaction.UserId = user.UserId.ToString(); // Ensure UserId is a string

            // Generate a unique ID for the transaction
            newTransaction.Id = Guid.NewGuid().ToString();

            // Define the path for the transaction data
            var filePath = Path.Combine(AppContext.BaseDirectory, "Components", "Data", "transactions.json");
            Debug.WriteLine($"Transaction file path: {filePath}");

            var transactions = new List<Transaction>();

            // Check if the file already exists and load its content
            if (File.Exists(filePath))
            {
                Debug.WriteLine("File exists. Reading content...");
                var json = await File.ReadAllTextAsync(filePath);

                // Check if file is not empty
                if (!string.IsNullOrWhiteSpace(json))
                {
                    Debug.WriteLine($"File content before deserialization: {json}");
                    try
                    {
                        transactions = JsonSerializer.Deserialize<List<Transaction>>(json) ?? new List<Transaction>();
                        Debug.WriteLine("Deserialization successful.");
                    }
                    catch (JsonException jsonEx)
                    {
                        Debug.WriteLine($"JSON deserialization error: {jsonEx.Message}");
                        Debug.WriteLine($"Stack Trace: {jsonEx.StackTrace}");
                        transactions = new List<Transaction>();
                    }
                }
                else
                {
                    Debug.WriteLine("File is empty. Initializing transactions as an empty list.");
                }
            }
            else
            {
                Debug.WriteLine("File does not exist. Creating a new one.");
            }

            // Add the new transaction to the list
            Debug.WriteLine($"Transaction being added: {JsonSerializer.Serialize(newTransaction)}");
            transactions.Add(newTransaction);

            // Serialize the transactions list back to JSON
            var updatedJson = JsonSerializer.Serialize(transactions, new JsonSerializerOptions { WriteIndented = true });
            Debug.WriteLine($"Updated JSON to be written: {updatedJson}");

            // Save the updated list to the file
            try
            {
                await File.WriteAllTextAsync(filePath, updatedJson);
                Debug.WriteLine("File successfully updated.");
            }
            catch (Exception writeEx)
            {
                Debug.WriteLine($"Error writing to file: {writeEx.Message}");
                Debug.WriteLine($"Stack Trace: {writeEx.StackTrace}");
            }

            // Redirect the user to the transactions page
            Navigator.NavigateTo("/transactions");
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"An error occurred: {ex.Message}");
            Debug.WriteLine($"Stack Trace: {ex.StackTrace}");
        }
    }

    private void Cancel()
    {
        Navigator.NavigateTo("/transactions");
    }
}
